
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>8: LSTM: The basics &#8212; Intro to Data Analysis and Machine Learning</title>
    
  <link href="_static/css/theme.css" rel="stylesheet">
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="8: Convolutional Neural Networks" href="lecture-7-cnns.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Intro to Data Analysis and Machine Learning</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="intro.html">
   Welcome to the Intro to Data Analysis and Machine Learning eBook
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="lecture-1-exploratory-data-analysis.html">
   1: Exploratory data analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lecture-2-clustering-kmeans-GMM.html">
   2: Clustering using k-means and GMM
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lecture-3-model-selection.html">
   Feature Engineering and Model Selection
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lecture-4-linear-regression.html">
   4: Linear regression
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lecture-4-naive-bayes.html">
   5:Naive Bayes classification
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lecture-5-decision-trees-classification.html">
   6: Classification using decision trees
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lecture-6-deep-neural-networks.html">
   7: Multi-layer Perceptrons
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lecture-7-cnns.html">
   8: Convolutional Neural Networks
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   8: LSTM: The basics
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/lecture-8-lstms.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/lecture-8-lstms.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#contents">
   Contents
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#converting-data-to-sequence-structure">
   Converting data to sequence structure
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-multi-variate-lstm">
   A multi-variate LSTM
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#importing-and-treating-the-data">
     Importing and treating the data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#converting-to-lstm-structure-data">
     Converting to $LSTM$ structure data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#building-the-network">
     Building the network
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#compile-the-network">
     Compile the network
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#train-the-network">
     Train the network
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#making-predictions-with-our-model">
     Making predictions with our model
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exercise">
     Exercise
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>8: LSTM: The basics</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#contents">
   Contents
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#converting-data-to-sequence-structure">
   Converting data to sequence structure
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-multi-variate-lstm">
   A multi-variate LSTM
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#importing-and-treating-the-data">
     Importing and treating the data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#converting-to-lstm-structure-data">
     Converting to $LSTM$ structure data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#building-the-network">
     Building the network
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#compile-the-network">
     Compile the network
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#train-the-network">
     Train the network
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#making-predictions-with-our-model">
     Making predictions with our model
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exercise">
     Exercise
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="lstm-the-basics">
<h1>8: LSTM: The basics<a class="headerlink" href="#lstm-the-basics" title="Permalink to this headline">¶</a></h1>
<p>In this notebook, we will learn the basics of a Long Short Term Memory (LSTM) based on <a class="reference external" href="https://keras.io/">Keras</a>, a high-level API for building and training deep learning models, running on top of <a class="reference external" href="https://www.tensorflow.org/">TensorFlow</a>, an open source platform for machine learning.</p>
<p>We will build a basic LSTM to predict stock prices in the future. The data is provided in your training environment - but in future you can also access it in <a class="reference external" href="https://github.com/mwitiderrick/stockprice">this github repo</a>.</p>
<section id="contents">
<h2>Contents<a class="headerlink" href="#contents" title="Permalink to this headline">¶</a></h2>
<ol class="simple">
<li><p><a class="reference external" href="#convert_data">Converting and preparing data</a></p></li>
<li><p><a class="reference external" href="#simple_lstm">A multi-variate LSTM</a></p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Importing the libraries</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MinMaxScaler</span>

<span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Dense</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">LSTM</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Dropout</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;ggplot&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><a id='convert_data'></a></p>
</section>
<section id="converting-data-to-sequence-structure">
<h2>Converting data to sequence structure<a class="headerlink" href="#converting-data-to-sequence-structure" title="Permalink to this headline">¶</a></h2>
<p>One of the critical features of $RNNs$ and $LSTMs$ is that they work on sequences of data. In the lecture notes we saw that the network takes input at a time $t$ and the hiden layer state from $t-1$ and produces an output:</p>
<a class="reference internal image-reference" href="https://github.com/stfc-sciml/sciml-workshop/blob/master/course_3.0_with_solutions/markdown_pic/lstms-1.png?raw=1"><img alt="lstms-1" src="https://github.com/stfc-sciml/sciml-workshop/blob/master/course_3.0_with_solutions/markdown_pic/lstms-1.png?raw=1" style="width: 500px;" /></a>
<p>However we may also want to include measured data from further back in time to help with remembering; so we could want input data from $t-1 \cdots t-n$. We might also have more than one channel of input data, this is called the  <strong>window</strong> of the data. Imagine for example we were predicting stock prices, we could have the history of that stock, but we might also want to know the central bank interest rate, or the strength of one currency relative to another, in this case we have a <strong>multi-variate</strong> problem. So our input data looks more like:</p>
<a class="reference internal image-reference" href="https://github.com/stfc-sciml/sciml-workshop/blob/master/course_3.0_with_solutions/markdown_pic/lstms-2.png?raw=1"><img alt="lstms-2" src="https://github.com/stfc-sciml/sciml-workshop/blob/master/course_3.0_with_solutions/markdown_pic/lstms-2.png?raw=1" style="width: 500px;" /></a>
<p>Also, we might also want to make our $LSTM$ predict more than just one step forward, so we will want to be able to have multiple steps in the output.</p>
<p>We write a function to convert dataframe series into data that is suitable for $LSTM$ training. This function is quite flexible and can be useful in many scenarios, so it is one that you might like to reuse in future if you are training time series models.</p>
<p>As input we pass the data as a <code class="docutils literal notranslate"><span class="pre">numpy</span></code> array. We then also specify how far back in time we wish to look for each prediction <code class="docutils literal notranslate"><span class="pre">n_in</span></code>, so <code class="docutils literal notranslate"><span class="pre">n_in</span> <span class="pre">=</span> <span class="pre">1</span></code> means we take just $t$ as input, <code class="docutils literal notranslate"><span class="pre">n_in=2</span></code> means we take $t, t-1$ as input and so on. We specify how far into the future we wish to predict, with the <code class="docutils literal notranslate"><span class="pre">n_out</span></code> variable. <code class="docutils literal notranslate"><span class="pre">n_out=1</span></code> means we predict for $t$, <code class="docutils literal notranslate"><span class="pre">n_out=2</span></code> means we predict for $t, t+1$ and so on. In addition to the window sizes, we can also select the features (columns in the data) to use with the <code class="docutils literal notranslate"><span class="pre">feature_indices</span></code> argument.</p>
<p>The series data can be infinitely long while the memory of our LSTM cannot not be infinitely large. Therefore, we need to specify the length of the LSTM, or the <code class="docutils literal notranslate"><span class="pre">timesteps</span></code>, which is usually much smaller than the total length of the series. The first dimension of the outputs (<code class="docutils literal notranslate"><span class="pre">X</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> for <code class="docutils literal notranslate"><span class="pre">TensorFlow</span></code>) is <code class="docutils literal notranslate"><span class="pre">batch</span></code>; time-dependency is ignored among the batches (i.e., they can be shuffled).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">series_to_tensorflow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">timesteps</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_in</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_out</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">feature_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a series to tensorflow input.</span>
<span class="sd">    Arguments:</span>
<span class="sd">       data: Sequence of observations as a 2D NumPy array of shape (n_times, n_features)</span>
<span class="sd">       n_in: Window size of input X</span>
<span class="sd">       n_out: Window size of output y</span>
<span class="sd">       feature_indices: select features by indices; pass None to use all features</span>
<span class="sd">       timesteps: timesteps of LSTM</span>
<span class="sd">    Returns:</span>
<span class="sd">       X and y for tensorflow.keras.layers.LSTM</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># sizes</span>
    <span class="n">n_total_times</span><span class="p">,</span> <span class="n">n_total_features</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">n_batches</span> <span class="o">=</span> <span class="n">n_total_times</span> <span class="o">-</span> <span class="n">timesteps</span> <span class="o">-</span> <span class="p">(</span><span class="n">n_in</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">n_out</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># feature selection</span>
    <span class="k">if</span> <span class="n">feature_indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">feature_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_total_features</span><span class="p">))</span>
    
    <span class="c1"># data</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">n_in</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_indices</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">n_out</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_indices</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i_batch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_batches</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i_in</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_in</span><span class="p">):</span>
            <span class="n">X_start</span> <span class="o">=</span> <span class="n">i_batch</span> <span class="o">+</span> <span class="n">i_in</span>
            <span class="n">X</span><span class="p">[</span><span class="n">i_batch</span><span class="p">,</span> <span class="p">:,</span> <span class="n">i_in</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">X_start</span><span class="p">:</span><span class="n">X_start</span> <span class="o">+</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">feature_indices</span><span class="p">]</span>
        <span class="n">y_start</span> <span class="o">=</span> <span class="n">i_batch</span> <span class="o">+</span> <span class="n">timesteps</span> <span class="o">+</span> <span class="n">n_in</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">y</span><span class="p">[</span><span class="n">i_batch</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">y_start</span><span class="p">:</span><span class="n">y_start</span> <span class="o">+</span> <span class="n">n_out</span><span class="p">,</span> <span class="n">feature_indices</span><span class="p">]</span>
    
    <span class="c1"># flatten the last two dimensions</span>
    <span class="k">return</span> <span class="n">X</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><a id='simple_lstm'></a></p>
</section>
<section id="a-multi-variate-lstm">
<h2>A multi-variate LSTM<a class="headerlink" href="#a-multi-variate-lstm" title="Permalink to this headline">¶</a></h2>
<section id="importing-and-treating-the-data">
<h3>Importing and treating the data<a class="headerlink" href="#importing-and-treating-the-data" title="Permalink to this headline">¶</a></h3>
<p>We first read in our data and inspect it using <code class="docutils literal notranslate"><span class="pre">pandas</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Importing the training set</span>
<span class="n">dataset_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;lstm-data/data-train-lstm.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset_train</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Last</th>
      <th>Close</th>
      <th>Total Trade Quantity</th>
      <th>Turnover (Lacs)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2018-09-28</td>
      <td>234.05</td>
      <td>235.95</td>
      <td>230.20</td>
      <td>233.50</td>
      <td>233.75</td>
      <td>3069914</td>
      <td>7162.35</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2018-09-27</td>
      <td>234.55</td>
      <td>236.80</td>
      <td>231.10</td>
      <td>233.80</td>
      <td>233.25</td>
      <td>5082859</td>
      <td>11859.95</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2018-09-26</td>
      <td>240.00</td>
      <td>240.00</td>
      <td>232.50</td>
      <td>235.00</td>
      <td>234.25</td>
      <td>2240909</td>
      <td>5248.60</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2018-09-25</td>
      <td>233.30</td>
      <td>236.75</td>
      <td>232.00</td>
      <td>236.25</td>
      <td>236.10</td>
      <td>2349368</td>
      <td>5503.90</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2018-09-24</td>
      <td>233.55</td>
      <td>239.20</td>
      <td>230.75</td>
      <td>234.00</td>
      <td>233.30</td>
      <td>3423509</td>
      <td>7999.55</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Dimensions of raw data: (n_times, n_features) = </span><span class="si">{</span><span class="n">dataset_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dimensions of raw data: (n_times, n_features) = (2035, 8)
</pre></div>
</div>
</div>
</div>
<p>In the next cell, we get rid of the <code class="docutils literal notranslate"><span class="pre">Date</span></code> column (the first column) and normalize the rest price columns to <code class="docutils literal notranslate"><span class="pre">[0,</span> <span class="pre">1]</span></code> using <code class="docutils literal notranslate"><span class="pre">MinMaxScaler</span></code> from <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># drop `Date` column</span>
<span class="n">values</span> <span class="o">=</span> <span class="n">dataset_train</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">dataset_train</span><span class="o">.</span><span class="n">columns</span><span class="p">[[</span><span class="mi">0</span><span class="p">,]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># normalize prices</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">(</span><span class="n">feature_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Dimensions of normalized price data: (n_times, n_features) = </span><span class="si">{</span><span class="n">scaled</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dimensions of normalized price data: (n_times, n_features) = (2035, 7)
</pre></div>
</div>
</div>
</div>
</section>
<section id="converting-to-lstm-structure-data">
<h3>Converting to $LSTM$ structure data<a class="headerlink" href="#converting-to-lstm-structure-data" title="Permalink to this headline">¶</a></h3>
<p>We now want to convert the data to a structure that can be fed to the $LSTM$. To do this we use our <code class="docutils literal notranslate"><span class="pre">series_to_tensorflow</span></code> function. In this case, we use 80 as the <code class="docutils literal notranslate"><span class="pre">timesteps</span></code>, looking back 8 steps (<code class="docutils literal notranslate"><span class="pre">n_in=8</span></code>) and projecting forward 4 steps (<code class="docutils literal notranslate"><span class="pre">n_out=4</span></code>) and considering the <code class="docutils literal notranslate"><span class="pre">Open</span></code> and <code class="docutils literal notranslate"><span class="pre">Close</span></code> prices (i.e., <code class="docutils literal notranslate"><span class="pre">feature_indices=[0,</span> <span class="pre">4]</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">timesteps</span> <span class="o">=</span> <span class="mi">80</span>
<span class="n">n_in</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">n_out</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">feature_indices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">series_to_tensorflow</span><span class="p">(</span><span class="n">scaled</span><span class="p">,</span> <span class="n">timesteps</span><span class="o">=</span><span class="n">timesteps</span><span class="p">,</span> 
                                        <span class="n">n_in</span><span class="o">=</span><span class="n">n_in</span><span class="p">,</span> <span class="n">n_out</span><span class="o">=</span><span class="n">n_out</span><span class="p">,</span> <span class="n">feature_indices</span><span class="o">=</span><span class="n">feature_indices</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Dimensions of X_train: (batches, timesteps, features) = </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Dimensions of y_train: (batches, features) = </span><span class="si">{</span><span class="n">y_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dimensions of X_train: (batches, timesteps, features) = (1945, 80, 16)
Dimensions of y_train: (batches, features) = (1945, 8)
</pre></div>
</div>
</div>
</div>
</section>
<section id="building-the-network">
<h3>Building the network<a class="headerlink" href="#building-the-network" title="Permalink to this headline">¶</a></h3>
<p><a id='build_lstm'></a></p>
<p>Note that as before we start off from a <code class="docutils literal notranslate"><span class="pre">Sequential</span></code> type model in <code class="docutils literal notranslate"><span class="pre">Keras</span></code>.</p>
<p>The $LSTM$ layers are already coded in <code class="docutils literal notranslate"><span class="pre">Keras</span></code> so we do not need to worry about writing the complicated structure. We just need to consider a few hyper-parametes we want to set,</p>
<ul class="simple">
<li><p>Number of LSTM layers - we can stack LSTM layers in this case we will start with 2 stacked LSTMs;</p></li>
<li><p>units - this is the dimensionality of the hidden state and memory cell of the LSTM;</p></li>
<li><p>return_sequences - should we return the full output sequence or just the final value in the sequence. Generally, if the LSTM layer is feeding to another layer in the network, this would be <code class="docutils literal notranslate"><span class="pre">True</span></code>; if the LSTM layer is the final layer then this is <code class="docutils literal notranslate"><span class="pre">False</span></code>; note default is <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialising the LSTM</span>
<span class="n">regressor</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>

<span class="c1"># Adding the first LSTM layer</span>
<span class="c1"># shape: (N, 80, 16) =&gt; (N, 80, 50)</span>
<span class="n">regressor</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">LSTM</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
                   <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>

<span class="c1"># Adding a second LSTM layer</span>
<span class="c1"># shape: (N, 80, 50) =&gt; (N, 24)</span>
<span class="n">regressor</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">LSTM</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,))</span>

<span class="c1"># Adding an output layer </span>
<span class="c1"># shape: (N, 24) =&gt; (N, 8)</span>
<span class="n">regressor</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="n">y_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="compile-the-network">
<h3>Compile the network<a class="headerlink" href="#compile-the-network" title="Permalink to this headline">¶</a></h3>
<p>As ususal we need to compile the network, choosing an optimiser and a loss function.</p>
<p>We use <code class="docutils literal notranslate"><span class="pre">adam</span></code> as our optimiser and <code class="docutils literal notranslate"><span class="pre">mean_squared_error</span></code> as our loss.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compiling the RNN</span>
<span class="n">regressor</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mean_squared_error&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="train-the-network">
<h3>Train the network<a class="headerlink" href="#train-the-network" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fitting the RNN to the Training set</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">regressor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/30
16/16 [==============================] - 4s 70ms/step - loss: 0.0421
Epoch 2/30
16/16 [==============================] - 1s 68ms/step - loss: 0.0093
Epoch 3/30
16/16 [==============================] - 1s 67ms/step - loss: 0.0049
Epoch 4/30
16/16 [==============================] - 1s 63ms/step - loss: 0.0036
Epoch 5/30
16/16 [==============================] - 1s 78ms/step - loss: 0.0032
Epoch 6/30
16/16 [==============================] - 1s 67ms/step - loss: 0.0030
Epoch 7/30
16/16 [==============================] - 1s 69ms/step - loss: 0.0028
Epoch 8/30
16/16 [==============================] - 1s 65ms/step - loss: 0.0028
Epoch 9/30
16/16 [==============================] - 1s 65ms/step - loss: 0.0026
Epoch 10/30
16/16 [==============================] - 1s 65ms/step - loss: 0.0025
Epoch 11/30
16/16 [==============================] - 1s 65ms/step - loss: 0.0025
Epoch 12/30
16/16 [==============================] - 1s 68ms/step - loss: 0.0026
Epoch 13/30
16/16 [==============================] - 1s 75ms/step - loss: 0.0024
Epoch 14/30
16/16 [==============================] - 1s 65ms/step - loss: 0.0025
Epoch 15/30
16/16 [==============================] - 1s 66ms/step - loss: 0.0023
Epoch 16/30
16/16 [==============================] - 1s 66ms/step - loss: 0.0022
Epoch 17/30
16/16 [==============================] - 1s 76ms/step - loss: 0.0022
Epoch 18/30
16/16 [==============================] - 1s 85ms/step - loss: 0.0022
Epoch 19/30
16/16 [==============================] - 1s 90ms/step - loss: 0.0022
Epoch 20/30
16/16 [==============================] - 1s 73ms/step - loss: 0.0022
Epoch 21/30
16/16 [==============================] - 1s 78ms/step - loss: 0.0021
Epoch 22/30
16/16 [==============================] - 1s 61ms/step - loss: 0.0020
Epoch 23/30
16/16 [==============================] - 1s 65ms/step - loss: 0.0021
Epoch 24/30
16/16 [==============================] - 1s 65ms/step - loss: 0.0021
Epoch 25/30
16/16 [==============================] - 1s 63ms/step - loss: 0.0021
Epoch 26/30
16/16 [==============================] - 1s 62ms/step - loss: 0.0020
Epoch 27/30
16/16 [==============================] - 1s 61ms/step - loss: 0.0019
Epoch 28/30
16/16 [==============================] - 1s 72ms/step - loss: 0.0021
Epoch 29/30
16/16 [==============================] - 1s 81ms/step - loss: 0.0020
Epoch 30/30
16/16 [==============================] - 1s 63ms/step - loss: 0.0019
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;mae&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/lecture-8-lstms_20_0.png" src="_images/lecture-8-lstms_20_0.png" />
</div>
</div>
</section>
<section id="making-predictions-with-our-model">
<h3>Making predictions with our model<a class="headerlink" href="#making-predictions-with-our-model" title="Permalink to this headline">¶</a></h3>
<p>We now use model that we just built to predict on previously un-seen data. We read in <code class="docutils literal notranslate"><span class="pre">data-test.csv</span></code> and get the stock prices from that data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Part 3 - Making the predictions and visualising the results</span>

<span class="c1"># Getting the real stock price of 2017</span>
<span class="n">dataset_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_path</span> <span class="o">+</span> <span class="s1">&#39;lstm-data/data-test-lstm.csv&#39;</span><span class="p">)</span>
<span class="n">real_stock_price</span> <span class="o">=</span> <span class="n">dataset_test</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dataset_test</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(16, 8)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset_test</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Last</th>
      <th>Close</th>
      <th>Total Trade Quantity</th>
      <th>Turnover (Lacs)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2018-10-24</td>
      <td>220.10</td>
      <td>221.25</td>
      <td>217.05</td>
      <td>219.55</td>
      <td>219.80</td>
      <td>2171956</td>
      <td>4771.34</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2018-10-23</td>
      <td>221.10</td>
      <td>222.20</td>
      <td>214.75</td>
      <td>219.55</td>
      <td>218.30</td>
      <td>1416279</td>
      <td>3092.15</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2018-10-22</td>
      <td>229.45</td>
      <td>231.60</td>
      <td>222.00</td>
      <td>223.05</td>
      <td>223.25</td>
      <td>3529711</td>
      <td>8028.37</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2018-10-19</td>
      <td>230.30</td>
      <td>232.70</td>
      <td>225.50</td>
      <td>227.75</td>
      <td>227.20</td>
      <td>1527904</td>
      <td>3490.78</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2018-10-17</td>
      <td>237.70</td>
      <td>240.80</td>
      <td>229.45</td>
      <td>231.30</td>
      <td>231.10</td>
      <td>2945914</td>
      <td>6961.65</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The testing data contain 16 time steps. We will concatenate them to the training data for time extension.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Getting the predicted stock price of 2017</span>
<span class="n">dataset_extended</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">dataset_train</span><span class="p">,</span> <span class="n">dataset_test</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">values_extended</span> <span class="o">=</span> <span class="n">dataset_extended</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">dataset_extended</span><span class="o">.</span><span class="n">columns</span><span class="p">[[</span><span class="mi">0</span><span class="p">,]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
<span class="n">scaled_extended</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">values_extended</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Dimensions of normalized price data: (n_times, n_features) = </span><span class="si">{</span><span class="n">scaled_extended</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dimensions of normalized price data: (n_times, n_features) = (2051, 7)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># using the last points to generate testing data</span>
<span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">series_to_tensorflow</span><span class="p">(</span><span class="n">scaled_extended</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="n">timesteps</span> <span class="o">+</span> <span class="n">n_in</span> <span class="o">+</span> <span class="n">n_out</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset_test</span><span class="p">)):],</span> 
                                      <span class="n">timesteps</span><span class="o">=</span><span class="n">timesteps</span><span class="p">,</span>
                                      <span class="n">n_in</span><span class="o">=</span><span class="n">n_in</span><span class="p">,</span> <span class="n">n_out</span><span class="o">=</span><span class="n">n_out</span><span class="p">,</span> <span class="n">feature_indices</span><span class="o">=</span><span class="n">feature_indices</span><span class="p">)</span>

<span class="c1"># make predictions</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">regressor</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Dimensions of X_test: (batches, timesteps, features) = </span><span class="si">{</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Dimensions of y_test: (batches, features) = </span><span class="si">{</span><span class="n">y_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Dimensions of y_pred: (batches, features) = </span><span class="si">{</span><span class="n">y_pred</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dimensions of X_test: (batches, timesteps, features) = (16, 80, 16)
Dimensions of y_test: (batches, features) = (16, 8)
Dimensions of y_pred: (batches, features) = (16, 8)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualising the results</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_indices</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> 
                       <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_indices</span><span class="p">),</span> <span class="mi">3</span><span class="p">),</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">feature_indices</span><span class="p">):</span>
    <span class="c1"># we are ploting the last point from the output window</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_test</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">+</span> <span class="p">(</span><span class="n">n_out</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_indices</span><span class="p">)],</span> 
                  <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Real &#39;</span> <span class="o">+</span> <span class="n">dataset_train</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_pred</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">+</span> <span class="p">(</span><span class="n">n_out</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_indices</span><span class="p">)],</span> 
                  <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Pred &#39;</span> <span class="o">+</span> <span class="n">dataset_train</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/lecture-8-lstms_27_0.png" src="_images/lecture-8-lstms_27_0.png" />
</div>
</div>
</section>
<section id="exercise">
<h3>Exercise<a class="headerlink" href="#exercise" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Build a network with three or four $LSTM$ layers. How does this affect the performance?</p></li>
<li><p>Change the LSTM timesteps (<code class="docutils literal notranslate"><span class="pre">timesteps</span></code>) - how does a longer/shorter one affect the predictions?</p></li>
<li><p>Try other window sizes and features.</p></li>
</ul>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="lecture-7-cnns.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">8: Convolutional Neural Networks</p>
        </div>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Keith T. Butler<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>